generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  admin
  user
}

enum UserStatus {
  active
  banned
}

enum ListingType {
  car
  building
  land
}

enum ListingStatus {
  draft
  published
  archived
}

enum MediaPurpose {
  listing
  chat
}

enum MediaKind {
  image
  video
}

enum MediaStatus {
  uploading
  ready
  failed
}

enum PreferredContact {
  chat
  whatsapp
  call
}

enum MessageKind {
  text
  media
}

enum ReportReason {
  spam
  scam
  harassment
  inappropriate
  other
}

enum ReportStatus {
  open
  reviewing
  resolved
  dismissed
}

enum NotificationType {
  NEW_MESSAGE
  NEW_INQUIRY
  LISTING_PUBLISHED
  SYSTEM
}

model User {
  id                       String                    @id @default(uuid()) @db.Uuid
  authUserId               String                    @unique @db.Uuid
  email                    String                    @unique
  role                     UserRole
  status                   UserStatus
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  listings                 Listing[]
  media                    Media[]
  inquiries                Inquiry[]
  buyerChats               Conversation[]            @relation("ConversationBuyer")
  sellerChats              Conversation[]            @relation("ConversationSeller")
  sentMessages             Message[]
  reportsFiled             Report[]                  @relation("ReportReporter")
  reportsReceived          Report[]                  @relation("ReportReported")
  bansReceived             Ban[]                     @relation("BanUser")
  bansIssued               Ban[]                     @relation("BanAdmin")
  notifications            Notification[]
  readStates               ConversationReadState[]
  conversationParticipants ConversationParticipant[]
  auditLogEntries          AdminAuditLog[]
}

model Listing {
  id              String         @id @default(uuid()) @db.Uuid
  type            ListingType
  title           String
  description     String
  price           Decimal        @db.Decimal(18, 2)
  currency        String
  locationCountry String
  locationRegion  String
  locationCity    String
  lat             Decimal?       @db.Decimal(9, 6)
  lng             Decimal?       @db.Decimal(9, 6)
  status          ListingStatus
  publishedAt     DateTime?
  createdById     String         @db.Uuid
  typeFields      Json?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       User           @relation(fields: [createdById], references: [id])
  listingMedia    ListingMedia[]
  inquiries       Inquiry[]
  conversations   Conversation[]
  dailyMetrics    ListingDailyMetrics[]
  dailyViewUniques ListingViewDailyUnique[]

  @@index([type, status, publishedAt(sort: Desc)])
  @@index([price])
  @@index([locationRegion, locationCity])
}

model Media {
  id            String         @id @default(uuid()) @db.Uuid
  ownerUserId   String         @db.Uuid
  purpose       MediaPurpose
  kind          MediaKind
  url           String
  thumbUrl      String?
  mime          String
  sizeBytes     BigInt
  durationSec   Int?
  status        MediaStatus
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  ownerUser     User           @relation(fields: [ownerUserId], references: [id])
  listingLinks  ListingMedia[]
  messageUsages Message[]
}

model ListingMedia {
  listingId String   @db.Uuid
  mediaId   String   @db.Uuid
  sortOrder Int
  createdAt DateTime @default(now())
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  media     Media    @relation(fields: [mediaId], references: [id], onDelete: NoAction)

  @@id([listingId, mediaId])
}

model Inquiry {
  id               String           @id @default(uuid()) @db.Uuid
  listingId        String           @db.Uuid
  buyerUserId      String           @db.Uuid
  message          String
  preferredContact PreferredContact
  phone            String?
  createdAt        DateTime         @default(now())
  listing          Listing          @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyerUser        User             @relation(fields: [buyerUserId], references: [id])
}

model Conversation {
  id            String    @id @default(uuid()) @db.Uuid
  listingId     String    @db.Uuid
  buyerUserId   String    @db.Uuid
  sellerUserId  String    @db.Uuid
  lastMessageAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  listing       Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyerUser     User      @relation("ConversationBuyer", fields: [buyerUserId], references: [id])
  sellerUser    User      @relation("ConversationSeller", fields: [sellerUserId], references: [id])
  messages      Message[]
  reports       Report[]
  readStates    ConversationReadState[]
  participants  ConversationParticipant[]

  @@unique([buyerUserId, listingId])
}

model Message {
  id             String       @id @default(uuid()) @db.Uuid
  conversationId String       @db.Uuid
  senderUserId   String       @db.Uuid
  kind           MessageKind
  text           String?
  mediaId        String?      @db.Uuid
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderUser     User         @relation(fields: [senderUserId], references: [id])
  media          Media?       @relation(fields: [mediaId], references: [id], onDelete: NoAction)
  reports        Report[]
  readByStates   ConversationReadState[] @relation("ConversationReadStateLastReadMessage")

  @@index([conversationId, createdAt(sort: Desc)])
}

model ConversationReadState {
  id                String       @id @default(cuid())
  conversationId    String       @db.Uuid
  userId            String       @db.Uuid
  lastReadMessageId String?      @db.Uuid
  lastReadAt        DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastReadMessage   Message?     @relation("ConversationReadStateLastReadMessage", fields: [lastReadMessageId], references: [id], onDelete: SetNull)

  @@unique([conversationId, userId])
  @@index([conversationId, userId])
  @@index([conversationId, lastReadAt])
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String       @db.Uuid
  userId         String       @db.Uuid
  role           String
  archivedAt     DateTime?
  pinnedAt       DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId, archivedAt])
  @@index([userId, pinnedAt])
  @@index([conversationId])
}

model Report {
  id             String       @id @default(cuid())
  reporterUserId String       @db.Uuid
  reportedUserId String       @db.Uuid
  conversationId String       @db.Uuid
  messageId      String?      @db.Uuid
  reason         ReportReason
  note           String?
  adminNote      String?
  status         ReportStatus @default(open)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  reporterUser   User         @relation("ReportReporter", fields: [reporterUserId], references: [id], onDelete: Cascade)
  reportedUser   User         @relation("ReportReported", fields: [reportedUserId], references: [id], onDelete: Cascade)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  message        Message?     @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
  @@index([reportedUserId, status])
  @@index([conversationId])
}

model Ban {
  id              String   @id @default(cuid())
  userId          String   @db.Uuid
  bannedByAdminId String   @db.Uuid
  reason          String?
  createdAt       DateTime @default(now())
  liftedAt        DateTime?
  user            User     @relation("BanUser", fields: [userId], references: [id], onDelete: Cascade)
  bannedByAdmin   User     @relation("BanAdmin", fields: [bannedByAdminId], references: [id], onDelete: Cascade)

  @@index([userId, liftedAt])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           @db.Uuid
  type      NotificationType
  title     String
  body      String?
  href      String?
  data      Json?
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, readAt, createdAt])
  @@index([userId, createdAt])
}

model ListingDailyMetrics {
  id                   String   @id @default(cuid())
  listingId            String   @db.Uuid
  date                 DateTime
  viewsTotal           Int      @default(0)
  viewsUnique          Int      @default(0)
  inquiriesTotal       Int      @default(0)
  conversationsStarted Int      @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  listing              Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date])
  @@index([date])
  @@index([listingId, date])
}

model ListingViewDailyUnique {
  id          String   @id @default(cuid())
  listingId   String   @db.Uuid
  date        DateTime
  visitorHash String
  createdAt   DateTime @default(now())
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date, visitorHash])
  @@index([listingId, date])
}

model AdminAuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  actorUserId String   @db.Uuid
  action      String
  entityType  String
  entityId    String
  metadata    Json
  createdAt   DateTime @default(now())
  actorUser   User     @relation(fields: [actorUserId], references: [id])
}
